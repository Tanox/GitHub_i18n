// ==UserScript==
// @name         GitHub 网站国际化之中文翻译
// @namespace    https://github.com/sutchan/GitHub_i18n
// @version      1.5.4
// @description  使用预定义词典实现 GitHub 全站高频 UI 中文翻译，零延迟、不破坏布局
// @author       Sut
// @match        https://github.com/*
// @grant        none
// @icon         https://github.githubassets.com/favicons/favicon.svg
// @updateURL    https://raw.githubusercontent.com/sutchan/GitHub_i18n/refs/heads/main/GitHub_zh-CN.userjs
// @downloadURL  https://raw.githubusercontent.com/sutchan/GitHub_i18n/refs/heads/main/GitHub_zh-CN.userjs
// ==/UserScript==

/**
 * GitHub 中文翻译用户脚本
 * 主要功能：将 GitHub 网站的高频 UI 元素翻译成中文，保持页面布局不变
 */
(function () {
    'use strict';

    // ========== 配置项 ==========
    const CONFIG = {
        // 当前脚本版本号（用于统一管理）
        version: '1.5.4',
        // 翻译延迟时间（毫秒）
        debounceDelay: 200,
        // 路由变化后翻译延迟时间（毫秒）
        routeChangeDelay: 400,
        // 是否启用调试日志
        debugMode: false,
        // 更新检测配置
        updateCheck: {
            // 是否启用自动更新检测
            enabled: true,
            // 更新检测间隔（小时）
            intervalHours: 24,
            // GitHub 原始脚本 URL
            scriptUrl: 'https://github.com/Tanox/GitHub_i18n/raw/main/GitHub_zh-CN.userjs',
            // 是否启用自动版本号更新
            autoUpdateVersion: true
        }
    };

    // ========== 翻译词典 ==========
    // 🔤 完整预定义翻译词典（覆盖导航、个人菜单、设置、组织、通知等）
    const TRANSLATION_DICT = {
        // ========== 顶部全局导航 ==========
        'Pull requests': '拉取请求',
        'Issues': '问题',
        'Actions': '操作',
        'Projects': '项目',
        'Wiki': '维基',
        'Security': '安全',
        'Insights': '洞察',
        'Settings': '设置',
        'Code': '代码',
        'Discussions': '讨论',
        'Marketplace': '市场',
        'Explore': '探索',
        'Copilot': 'Copilot',
        'Notifications': '通知',
        'New repository': '新建仓库',
        'Import repository': '导入仓库',
        'New gist': '新建代码片段',
        'New organization': '新建组织',
        'New codespace': '新建 Codespace',
        'Your profile': '个人资料',
        'Your repositories': '你的仓库',
        'Your stars': '你的标星',
        'Your gists': '你的代码片段',
        'Your codespaces': '你的 Codespaces',
        'Your projects': '你的项目',
        'Your organizations': '你的组织',
        'Your notifications': '你的通知',
        'Feature preview': '功能预览',
        'Help': '帮助',
        'Sign out': '退出登录',
        'Signed in as': '已登录为',
        'Dashboard': '仪表盘',

        // ========== 仓库页主导航（UnderlineNav）==========
        'Overview': '概览',
        'Commits': '提交',
        'Branches': '分支',
        'Tags': '标签',
        'Releases': '发布',
        'Packages': '包',
        'Environments': '环境',
        'Contributors': '贡献者',
        'Activity': '活动',
        'Dependency graph': '依赖关系图',
        'Dependabot': 'Dependabot',
        'Code scanning': '代码扫描',
        'Secret scanning': '密钥扫描',
        'Audit log': '审计日志',
        'Billing': '账单',
        'Members': '成员',
        'Teams': '团队',
        'Custom properties': '自定义属性',
        'Moderation settings': '审核设置',
        'Installed GitHub Apps': '已安装的 GitHub 应用',
        'Webhooks': 'Webhooks',
        'Service hooks': '服务钩子',
        'Deploy keys': '部署密钥',
        'Self-hosted runners': '自托管运行器',
        'Runner groups': '运行器组',
        'Variables': '变量',
        'Secrets': '密钥',
        'Pages': 'Pages',
        'Actions secrets': '操作密钥',
        'Artifacts': '产物',
        'Caches': '缓存',
        'Workflows': '工作流',
        'Runs': '运行记录',
        'Summary': '摘要',
        'Jobs': '任务',
        'Logs': '日志',

        // ========== 仓库操作菜单（右上角 "Code" 按钮下拉）==========
        'Clone': '克隆',
        'Open with GitHub Desktop': '使用 GitHub Desktop 打开',
        'Open with Codespaces': '使用 Codespaces 打开',
        'Download ZIP': '下载 ZIP',
        'Local': '本地',
        'GitHub CLI': 'GitHub CLI',
        'HTTPS': 'HTTPS',
        'Use SSH': '使用 SSH',
        'Use HTTPS': '使用 HTTPS',

        // ========== Issues / PR 操作菜单 ==========
        'New issue': '新建问题',
        'New pull request': '新建拉取请求',
        'Assignees': '负责人',
        'Labels': '标签',
        'Projects': '项目',
        'Milestone': '里程碑',
        'Development': '开发',
        'Linked pull requests': '关联的拉取请求',
        'Convert to issue': '转换为问题',
        'Close issue': '关闭问题',
        'Reopen issue': '重新开启问题',
        'Close pull request': '关闭拉取请求',
        'Ready for review': '准备审核',
        'Mark as draft': '标记为草稿',
        'Reviewers': '审核人',
        'Request review': '请求审核',
        'Add reaction': '添加反应',
        'Subscribe': '订阅',
        'Unsubscribe': '取消订阅',

        // ========== 个人主页标签 ==========
        'Repositories': '仓库',
        'Stars': '标星',
        'Followers': '关注者',
        'Following': '关注中',
        'Sponsoring': '赞助中',
        'Sponsors': '赞助者',
        'Highlights': '亮点',
        'Pinned': '置顶',

        // ========== 设置页面主菜单（左侧边栏）==========
        'Home': '首页',
        'Account': '账户',
        'Profile': '个人资料',
        'Account security': '账户安全',
        'Sessions': '登录会话',
        'SSH and GPG keys': 'SSH 和 GPG 密钥',
        'Access tokens': '访问令牌',
        'Sponsored developers': '赞助开发者',
        'Organization memberships': '组织成员资格',
        'Email': '邮箱',
        'Public email': '公开邮箱',
        'Business': '企业',
        'Connected accounts': '已连接账户',
        'Block users': '屏蔽用户',
        'Delete account': '删除账户',
        'Preferences': '偏好设置',
        'Appearance': '外观',
        'Accessibility': '无障碍',
        'Notifications': '通知',
        'Email notifications': '邮件通知',
        'Watched repositories': '关注的仓库',
        'Scheduled digests': '定期摘要',
        'Integrations': '集成',
        'Authorized OAuth Apps': '授权的 OAuth 应用',
        'Authorized GitHub Apps': '授权的 GitHub 应用',
        'Webhooks': 'Webhooks',
        'Service hooks': '服务钩子',
        'Billing & plans': '账单与计划',
        'Developer settings': '开发者设置',
        'Fine-grained personal access tokens': '精细个人访问令牌',
        'Personal access tokens (classic)': '个人访问令牌（经典）',
        'OAuth Apps': 'OAuth 应用',
        'GitHub Apps': 'GitHub 应用',
        'Codespaces': 'Codespaces',
        'Copilot': 'Copilot',
        'Pages': 'Pages',
        'Actions': '操作',
        'Packages': '包',
        'Security log': '安全日志',

        // ========== 组织设置菜单 ==========
        'Organization settings': '组织设置',
        'Profile': '资料',
        'People': '成员',
        'Teams': '团队',
        'Billing': '账单',
        'SAML SSO': 'SAML SSO',
        'Audit log': '审计日志',
        'Actions': '操作',
        'Packages': '包',
        'Secrets and variables': '密钥与变量',
        'Codespaces': 'Codespaces',
        'Pages': 'Pages',
        'Webhooks': 'Webhooks',
        'OAuth Apps': 'OAuth 应用',
        'GitHub Apps': 'GitHub 应用',
        'Installed GitHub Apps': '已安装的 GitHub 应用',
        'Custom properties': '自定义属性',
        'Member privileges': '成员权限',
        'Third-party access': '第三方访问',
        'Moderation settings': '审核设置',
        'Repository defaults': '仓库默认设置',
        'Repository roles': '仓库角色',
        'Code security': '代码安全',
        'Dependabot': 'Dependabot',
        'Code scanning': '代码扫描',
        'Secret scanning': '密钥扫描',
        'Advanced security': '高级安全',
        'Migration': '迁移',
        'Blocked users': '被屏蔽用户',
        'Domain settings': '域名设置',
        'Enterprise': '企业',

        // ========== 通知中心 ==========
        'Unread': '未读',
        'Participating': '参与的',
        'All': '全部',
        'Custom': '自定义',
        'Mark all as read': '全部标记为已读',
        'Mute thread': '静音此会话',
        'Unmute thread': '取消静音',
        'Save': '保存',
        'Saved': '已保存',

        // ========== 邮箱与密钥 ==========
        'Email address': '邮箱地址',
        'Primary email address': '主邮箱地址',
        'Add email address': '添加邮箱地址',
        'Verified': '已验证',
        'Unverified': '未验证',
        'Set as primary': '设为主邮箱',
        'Make private': '设为私有',
        'Make public': '设为公开',
        'Resend email': '重新发送邮件',
        'Remove': '移除',

        'SSH keys': 'SSH 密钥',
        'New SSH key': '新建 SSH 密钥',
        'Title': '标题',
        'Key': '密钥',
        'Add SSH key': '添加 SSH 密钥',
        'GPG keys': 'GPG 密钥',
        'New GPG key': '新建 GPG 密钥',
        'Add GPG key': '添加 GPG 密钥',
        'Public key': '公钥',

        // ========== 令牌 ==========
        'Personal access tokens': '个人访问令牌',
        'Fine-grained tokens': '精细令牌',
        'Tokens (classic)': '经典令牌',
        'Generate new token': '生成新令牌',
        'Note': '备注',
        'Expires': '过期时间',
        'Token': '令牌',
        'Configure': '配置',
        'Regenerate': '重新生成',
        'Revoke': '撤销',

        // ========== Codespaces ==========
        'Codespaces': 'Codespaces',
        'New codespace': '新建 Codespace',
        'Recent codespaces': '最近的 Codespaces',
        'Dev containers': '开发容器',
        'Settings': '设置',
        'Preferences': '偏好设置',
        'Features': '功能',
        'Port forwarding': '端口转发',
        'Visual Studio Code': 'Visual Studio Code',
        'Browser': '浏览器',
        'Start': '启动',
        'Stop': '停止',
        'Restart': '重启',
        'Export': '导出',
        'Delete codespace': '删除 Codespace',

        // ========== 其他通用 UI ==========
        'Public': '公开',
        'Private': '私有',
        'Internal': '内部',
        'Visibility': '可见性',
        'Description': '描述',
        'Homepage': '主页',
        'Website': '网站',
        'Location': '位置',
        'Company': '公司',
        'Twitter username': 'Twitter 用户名',
        'Pronouns': '代词',
        'Bio': '简介',
        'Update profile': '更新资料',
        'Change your avatar': '更换头像',
        'Upload a new photo': '上传新照片',
        'Save changes': '保存更改',
        'Cancel': '取消',
        'Close': '关闭',
        'Delete': '删除',
        'Edit': '编辑',
        'Rename': '重命名',
        'Transfer': '转移',
        'Danger Zone': '危险区域',
        'Permanently delete': '永久删除',
        'Are you sure?': '你确定吗？',
        'Confirm': '确认',
        'Search': '搜索',
        'Filter': '筛选',
        'Sort': '排序',
        'Loading': '加载中',
        'No results found': '未找到结果',
        'Write': '撰写',
        'Preview': '预览',
        'Quote reply': '引用回复',
        'React': '反应',
        'View source': '查看源码',
        'Jump to': '跳转到',
        'Quickly navigate files': '快速导航文件',
        'Recent activity': '最近活动',
        'Popular repositories': '热门仓库',
        'Topics': '主题',
        'Collections': '合集',
        'Templates': '模板',
        'Archived': '已归档',
        'Forked from': '复刻自',
        'Mirror': '镜像',
        'Template': '模板仓库',
        'Sponsor': '赞助',
        'Sponsor this project': '赞助此项目',
        'Back this project': '支持此项目',
        'Learn more': '了解更多',
        'Documentation': '文档',
        'API': 'API',
        'Community': '社区',
        'Support': '支持',
        'Report abuse': '举报滥用',
        'Contact GitHub': '联系 GitHub',
        'Status': '状态',
        'Training': '培训',
        'Blog': '博客',
        'About': '关于',
        'Terms': '条款',
        'Privacy': '隐私',
        'Security': '安全',
        'Team': '团队',
        'Enterprise': '企业版',

        // ========== 仓库操作（扩展）==========
        'Create repository': '创建仓库',
        'Fork': '复刻',
        'Watch': '关注',
        'Star': '标星',
        'Discard changes': '放弃更改',
        'Commit changes': '提交更改',
        'Sync fork': '同步复刻',
        'Create new file': '创建新文件',
        'Upload files': '上传文件',
        'Find file': '查找文件',
        'Go to file': '转到文件',
        'Raw': '原始',
        'Blame': '代码归属',
        'History': '历史',
        'Download': '下载',
        'Copy': '复制',
        'Permalink': '永久链接',
        
        // ========== Pull Request（扩展）==========
        'Create pull request': '创建拉取请求',
        'Merge pull request': '合并拉取请求',
        'Squash and merge': '压缩并合并',
        'Rebase and merge': '变基并合并',
        'Resolve conflicts': '解决冲突',
        'Review changes': '审查更改',
        'Approved': '已批准',
        'Changes requested': '请求更改',
        
        // ========== Issues（扩展）==========
        'Comment': '评论',
        'Close with comment': '带评论关闭',
        'Assign yourself': '分配给自己',
        'Lock conversation': '锁定会话',
        'Unlock conversation': '解锁会话',
        
        // ========== 搜索与筛选（扩展）==========
        'This repository': '当前仓库',
        'All repositories': '所有仓库',
        'In this organization': '在此组织中',
        'Search in': '搜索范围',
        'Sort by': '排序方式',
        'Filter by': '筛选条件',
        'Most stars': '最多标星',
        'Most forks': '最多复刻',
        'Recently updated': '最近更新',
        'Language': '语言',
        
        // ========== 代码审查（扩展）==========
        'Approve': '批准',
        'Request changes': '请求更改',
        'Comment': '评论',
        'Viewed': '已查看',
        'Hide whitespace': '隐藏空白',
        'Show whitespace': '显示空白',
        'Start review': '开始审查',
        'Finish your review': '完成审查',
        
        // ========== 其他常用UI（扩展）==========
        'Collaborators': '协作者',
        'Invite a collaborator': '邀请协作者',
        'Manage access': '管理访问权限',
        'Compare': '比较',
        'Insights': '洞察',
        'Marketplace': '市场',
        'Sponsor': '赞助',
        'Settings': '设置',
        'Toggle dark mode': '切换深色模式',
        'Toggle light mode': '切换浅色模式',
        'Default branch': '默认分支',
        'Switch branches/tags': '切换分支/标签',
        'Create branch': '创建分支',
        'Create tag': '创建标签',
        'Delete branch': '删除分支',
        'Delete tag': '删除标签',
        'Gitpod': 'Gitpod',
        'Open in Visual Studio Code': '在 Visual Studio Code 中打开',
        'Open in Visual Studio': '在 Visual Studio 中打开',
        'Open with': '使用...打开',
        'Print': '打印',
        'Keyboard shortcuts': '键盘快捷键',
        'Log out': '登出',
        
        // ========== 新增菜单翻译 ==========
        // 仓库页面菜单
        'Code': '代码',
        'Issues': '问题',
        'Pull requests': '拉取请求',
        'Projects': '项目',
        'Wiki': '维基',
        'Security': '安全',
        'Actions': '操作',
        'Packages': '包',
        'Environments': '环境',
        
        // Issues页面菜单
        'Open': '开放',
        'Closed': '已关闭',
        'Labels': '标签',
        'Milestones': '里程碑',
        'Assignees': '经办人',
        
        // Pull Requests页面菜单
        'All': '全部',
        'Your pull requests': '您的拉取请求',
        'Merged': '已合并',
        
        // 克隆菜单
        'Clone': '克隆',
        'HTTPS': 'HTTPS',
        'SSH': 'SSH',
        'GitHub CLI': 'GitHub 命令行',
        'Open with GitHub Desktop': '用 GitHub Desktop 打开',
        'Download ZIP': '下载 ZIP',
        
        // 分支/标签菜单
        'Recent branches': '最近分支',
        'Recent tags': '最近标签',
        
        // 文件操作菜单
        'Delete file': '删除文件',
        'Move file': '移动文件',
        'Rename file': '重命名文件',
        'View blame': '查看代码归属',
        'View history': '查看历史',
        
        // 设置页面菜单
        'General': '通用',
        'Account': '账户',
        'Notifications': '通知',
        'Emails': '邮箱',
        'Security': '安全',
        'SSH and GPG keys': 'SSH和GPG密钥',
        'Developer settings': '开发者设置',
        'Billing': '账单',
        'Plan': '计划',
        
        // 开发者设置
        'Personal access tokens': '个人访问令牌',
        'OAuth apps': 'OAuth应用',
        'GitHub Apps': 'GitHub应用',
        'Fine-grained tokens': '细粒度令牌',
        
        // 代码审查菜单
        'Reviewers': '审查者',
        'Assignees': '经办人',
        'Labels': '标签',
        'Projects': '项目',
        'Milestone': '里程碑',
        
        // 洞察页面菜单
        'Overview': '概览',
        'Contributors': '贡献者',
        'Traffic': '流量',
        'Commits': '提交',
        'Code frequency': '代码频率',
        'Network': '网络',
        'Dependency graph': '依赖图',
        'Dependabot alerts': 'Dependabot提醒',
        'Security insights': '安全洞察',
        
        // 其他常用术语
        'Save': '保存',
        'Cancel': '取消',
        'Apply': '应用',
        'Update': '更新',
        'Delete': '删除',
        'Create': '创建',
        'Edit': '编辑',
        'Preview': '预览',
        'Commit message': '提交信息',
        'Add file': '添加文件',
        'Commit directly to the': '直接提交到',
        'branch': '分支',
        'Create a new branch for this commit and start a pull request': '为此提交创建新分支并开始拉取请求',
        'Submit new issue': '提交新问题',
        'Submit new pull request': '提交新拉取请求',
        'Write': '编写',
        'Preview': '预览',
        'Attach files by dragging & dropping, uploading from your computer, or pasting from the clipboard.': '通过拖放、从计算机上传或从剪贴板粘贴附加文件。',
        'Close issue': '关闭问题',
        'Reopen issue': '重新打开问题',
        'Close pull request': '关闭拉取请求',
        'Reopen pull request': '重新打开拉取请求',
        'Merge pull request': '合并拉取请求',
        'Confirm merge': '确认合并',
        'Delete branch': '删除分支',
        'Delete branch after merge': '合并后删除分支',
        'View pull request': '查看拉取请求',
        'View commit': '查看提交',
        'View issue': '查看问题',
        'View file': '查看文件',
        'View directory': '查看目录',
        'Copy link': '复制链接',
        'Copy raw content': '复制原始内容',
        'Open raw': '打开原始内容',
        'Open in new window': '在新窗口打开',
        'Open in new tab': '在新标签页打开',
        
        // ========== ActionList 相关翻译 ==========
        'ActionList': '操作列表',
        'prc-ActionList-ActionList-X4RiC': '操作列表组件'
    };
    /**
     * 安全替换文本节点（不破坏 HTML 结构和布局）
     * @param {Node} node - 要处理的 DOM 节点
     */
    function replaceTextNodes(node) {
        if (!node || node.nodeType !== Node.ELEMENT_NODE) return;
        
        // 跳过不应翻译的区域
        const skipTags = ['SCRIPT', 'STYLE', 'TEXTAREA', 'INPUT', 'CODE', 'PRE', 'KBD'];
        if (skipTags.includes(node.tagName)) return;
        if (node.closest?.('code, pre, .js-file-line, .commit-tease, .copy-button, .blob-code')) return;

        for (let i = 0; i < node.childNodes.length; i++) {
            const child = node.childNodes[i];
            if (child.nodeType === Node.TEXT_NODE) {
                const text = child.textContent.trim();
                if (text && TRANSLATION_DICT.hasOwnProperty(text)) {
                    // 仅替换匹配部分，保留前后空白（避免破坏布局）
                    child.textContent = child.textContent.replace(text, TRANSLATION_DICT[text]);
                    if (CONFIG.debugMode) {
                        console.log(`[GitHub_i18n] 已翻译: "${text}" -> "${TRANSLATION_DICT[text]}"`);
                    }
                }
            } else if (child.nodeType === Node.ELEMENT_NODE) {
                replaceTextNodes(child);
            }
        }
    }

    /**
     * 翻译页面上的关键区域
     */
    function translatePage() {
        const selectors = [
            '#header',                          // 顶部导航栏
            '.Header-item--full',               // 中央菜单
            '.HeaderMenu',                      // 个人下拉菜单容器
            '.UnderlineNav',                    // 仓库页标签导航
            '.dropdown-menu',                   // 所有下拉菜单
            '.BorderGrid',                      // 设置页面网格
            '.Box',                             // 设置项容器
            '.menu-item',                       // 菜单项
            '.js-selected-navigation-item',     // 选中项
            '.Layout',                          // 通用布局容器
            '.application-main'                 // 主内容区（保守使用）
        ];

        // 优化：合并选择器查询以提高性能
        const combinedSelector = selectors.join(', ');
        document.querySelectorAll(combinedSelector).forEach(el => {
            replaceTextNodes(el);
        });
    }

    /**
     * 初始化翻译功能
     */
    function init() {
        // 初始翻译
        translatePage();

        // 设置 MutationObserver 监听动态内容变化
        const observer = new MutationObserver(() => {
            // 防抖 + 延迟确保元素渲染完成
            clearTimeout(observer.timer);
            observer.timer = setTimeout(translatePage, CONFIG.debounceDelay);
        });

        // 开始监听
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // 监听 SPA 路由变化
        const originalPushState = history.pushState;
        history.pushState = function (...args) {
            originalPushState.apply(this, args);
            setTimeout(translatePage, CONFIG.routeChangeDelay);
        };
        
        window.addEventListener('popstate', () => {
            setTimeout(translatePage, CONFIG.routeChangeDelay);
        });

        if (CONFIG.debugMode) {
            console.log(`[GitHub_i18n] 已成功初始化，当前版本: ${CONFIG.version}`);
        }
    }

    /**
     * 检查脚本更新
     * @description 自动检测GitHub上的最新版本，并在有更新时通知用户
     */
    function checkForUpdates() {
        if (!CONFIG.updateCheck.enabled) return;
        
        try {
            // 获取当前版本
            const currentVersion = CONFIG.version;
            
            // 获取上次检查时间
            const lastCheckTime = localStorage.getItem('GitHub_i18n_lastUpdateCheck');
            const now = Date.now();
            const intervalMs = CONFIG.updateCheck.intervalHours * 60 * 60 * 1000;
            
            // 如果距离上次检查未超过设定间隔，则跳过检查
            if (lastCheckTime && now - parseInt(lastCheckTime) < intervalMs) {
                if (CONFIG.debugMode) {
                    console.log('[GitHub_i18n] 未到更新检测时间');
                }
                return;
            }
            
            // 更新上次检查时间
            localStorage.setItem('GitHub_i18n_lastUpdateCheck', now.toString());
            
            // 发送请求获取最新版本
            fetch(CONFIG.updateCheck.scriptUrl, {
                method: 'GET',
                cache: 'no-cache'
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.text();
            })
            .then(content => {
                // 从脚本内容中提取版本号
                const versionMatch = content.match(/\/\/\s*@version\s+(\S+)/);
                if (versionMatch && versionMatch[1]) {
                    const latestVersion = versionMatch[1];
                    
                    if (CONFIG.debugMode) {
                        console.log(`[GitHub_i18n] 当前版本: ${currentVersion}, 最新版本: ${latestVersion}`);
                    }
                    
                    // 比较版本号
                    if (isNewerVersion(latestVersion, currentVersion)) {
                        showUpdateNotification(latestVersion, currentVersion);
                         
                        // 如果启用了自动版本号更新，则更新本地版本记录
                        if (CONFIG.updateCheck.autoUpdateVersion) {
                            updateLocalVersion(latestVersion);
                        }
                    }
                }
            })
            .catch(error => {
                if (CONFIG.debugMode) {
                    console.error('[GitHub_i18n] 检查更新失败:', error);
                }
            });
        } catch (error) {
            if (CONFIG.debugMode) {
                console.error('[GitHub_i18n] 更新检查功能异常:', error);
            }
        }
    }
    
    /**
     * 更新本地存储的版本号
     * @param {string} newVersion - 新版本号
     */
    function updateLocalVersion(newVersion) {
        try {
            // 存储新版本号到 localStorage
            localStorage.setItem('GitHub_i18n_latestVersion', newVersion);
            
            if (CONFIG.debugMode) {
                console.log(`[GitHub_i18n] 已更新本地版本号记录: ${CONFIG.version} → ${newVersion}`);
            }
        } catch (error) {
            if (CONFIG.debugMode) {
                console.error('[GitHub_i18n] 更新本地版本号失败:', error);
            }
        }
    }
    
    /**
     * 比较版本号，判断是否为新版本
     * @param {string} latestVersion - 最新版本号
     * @param {string} currentVersion - 当前版本号
     * @returns {boolean} 是否为新版本
     */
    function isNewerVersion(latestVersion, currentVersion) {
        try {
            const latestParts = latestVersion.split('.').map(Number);
            const currentParts = currentVersion.split('.').map(Number);
            
            // 比较每个版本部分
            for (let i = 0; i < Math.max(latestParts.length, currentParts.length); i++) {
                const latest = latestParts[i] || 0;
                const current = currentParts[i] || 0;
                
                if (latest > current) return true;
                if (latest < current) return false;
            }
            return false; // 版本相同
        } catch (error) {
            // 版本格式异常时，直接比较字符串
            return latestVersion !== currentVersion;
        }
    }
    
    /**
     * 显示更新通知
     * @param {string} latestVersion - 最新版本号
     * @param {string} currentVersion - 当前版本号
     */
    function showUpdateNotification(latestVersion, currentVersion) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = 'GitHub_i18n_update_notification';
        notification.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #0366d6;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 14px;
            max-width: 400px;
            cursor: pointer;
            transition: opacity 0.3s;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16v-2"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <div>
                    <div style="font-weight: 500;">GitHub 中文翻译脚本有更新</div>
                    <div style="opacity: 0.9; margin-top: 2px;">版本 ${currentVersion} → ${latestVersion}</div>
                </div>
            </div>
        `;
        
        // 点击通知跳转到安装页面
        notification.addEventListener('click', () => {
            window.open(CONFIG.updateCheck.scriptUrl, '_blank');
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        });
        
        // 自动关闭
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 15000);
        
        // 添加到页面
        document.body.appendChild(notification);
    }
    
    /**
     * 处理版本号自动升级
     * @description 检查本地存储的版本号，实现自动升级逻辑
     */
    function handleVersionAutoUpgrade() {
        try {
            // 检查 localStorage 中是否有最新版本号记录
            const storedLatestVersion = localStorage.getItem('GitHub_i18n_latestVersion');
            
            if (storedLatestVersion && CONFIG.updateCheck.autoUpdateVersion) {
                // 比较存储的版本号和当前版本号
                if (isNewerVersion(storedLatestVersion, CONFIG.version)) {
                    if (CONFIG.debugMode) {
                        console.log(`[GitHub_i18n] 检测到已通知的新版本: ${CONFIG.version} → ${storedLatestVersion}`);
                        console.log(`[GitHub_i18n] 请访问脚本安装页面更新到最新版本`);
                    }
                }
            }
        } catch (error) {
            if (CONFIG.debugMode) {
                console.error('[GitHub_i18n] 版本自动升级处理失败:', error);
            }
        }
    }
    
    /**
     * 启动脚本
     */
    function startScript() {
        // 处理版本自动升级
        handleVersionAutoUpgrade();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                init();
                // 初始化后检查更新
                if (CONFIG.updateCheck.enabled) {
                    // 延迟检查，避免影响页面加载性能
                    setTimeout(checkForUpdates, 5000);
                }
            });
        } else {
            init();
            // 初始化后检查更新
            if (CONFIG.updateCheck.enabled) {
                // 延迟检查，避免影响页面加载性能
                setTimeout(checkForUpdates, 5000);
            }
        }
    }
    // 🕒 启动脚本
    startScript();

})();