<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API端点测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // 等待DOM加载完成后再配置Tailwind
        document.addEventListener('DOMContentLoaded', function() {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#4f46e5',
                            secondary: '#10b981',
                            accent: '#6366f1',
                            danger: '#ef4444',
                            dark: '#1e293b',
                            light: '#f8fafc',
                            success: '#10b981',
                            'success-light': '#d1fae5',
                            error: '#ef4444',
                            'error-light': '#fee2e2'
                        },
                        fontFamily: {
                            inter: ['Inter', 'system-ui', 'sans-serif'],
                        },
                        boxShadow: {
                            'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                            'button': '0 2px 4px rgba(0, 0, 0, 0.1)'
                        }
                    },
                }
            };
        });
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                transition: all 0.3s ease;
            }
            .card-shadow:hover {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
            }
            .btn-hover {
                transition: all 0.2s ease-in-out;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
            }
            .loading-shimmer {
                position: relative;
                overflow: hidden;
            }
            .loading-shimmer::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                animation: shimmer 1.5s infinite;
            }
            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }
            .fade-in {
                animation: fadeIn 0.4s ease-in;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 头部 -->
        <header class="mb-8 fade-in">
            <div class="flex items-center space-x-3 mb-2">
                <div class="bg-primary/10 p-2 rounded-lg">
                    <i class="fa fa-server text-primary text-2xl"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold text-dark">API端点测试</h1>
            </div>
            <p class="text-gray-500">测试GitHub自动化字符串更新工具的API端点连接性和响应</p>
        </header>

        <!-- API端点测试区域 -->
        <div class="space-y-6">
            <!-- 配置端点 -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-gray-100 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-dark flex items-center">
                        <span class="bg-primary text-white text-xs font-bold px-2 py-1 rounded mr-3">1</span>
                        /api/config - 获取配置
                    </h2>
                    <div class="flex items-center">
                        <div class="status px-3 py-1 rounded-full text-sm font-medium mr-4" id="config-status">
                            <i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试
                        </div>
                        <button type="button" onclick="testConfig()" class="btn-hover bg-secondary text-white px-4 py-2 rounded-md flex items-center shadow-button">
                            <i class="fa fa-play-circle mr-2"></i>测试端点
                        </button>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto font-mono text-sm border border-gray-200">
                    <pre id="config-result" class="whitespace-pre-wrap break-all"></pre>
                </div>
            </div>

            <!-- 页面配置端点 -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-gray-100 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-dark flex items-center">
                        <span class="bg-primary text-white text-xs font-bold px-2 py-1 rounded mr-3">2</span>
                        /api/pages - 获取页面配置
                    </h2>
                    <div class="flex items-center">
                        <div class="status px-3 py-1 rounded-full text-sm font-medium mr-4" id="pages-status">
                            <i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试
                        </div>
                        <button type="button" onclick="testPages()" class="btn-hover bg-secondary text-white px-4 py-2 rounded-md flex items-center shadow-button">
                            <i class="fa fa-play-circle mr-2"></i>测试端点
                        </button>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto font-mono text-sm border border-gray-200">
                    <pre id="pages-result" class="whitespace-pre-wrap break-all"></pre>
                </div>
            </div>

            <!-- 统计数据端点 -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-gray-100 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-dark flex items-center">
                        <span class="bg-primary text-white text-xs font-bold px-2 py-1 rounded mr-3">3</span>
                        /api/stats - 获取统计数据
                    </h2>
                    <div class="flex items-center">
                        <div class="status px-3 py-1 rounded-full text-sm font-medium mr-4" id="stats-status">
                            <i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试
                        </div>
                        <button type="button" onclick="testStats()" class="btn-hover bg-secondary text-white px-4 py-2 rounded-md flex items-center shadow-button">
                            <i class="fa fa-play-circle mr-2"></i>测试端点
                        </button>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto font-mono text-sm border border-gray-200">
                    <pre id="stats-result" class="whitespace-pre-wrap break-all"></pre>
                </div>
            </div>

            <!-- 批量测试 -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-gray-100 fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <h2 class="text-lg font-semibold text-dark mb-4 md:mb-0">
                        <i class="fa fa-cogs mr-2 text-primary"></i>批量测试
                    </h2>
                    <div class="flex space-x-4">
                        <button type="button" onclick="testAll()" class="btn-hover bg-primary text-white px-5 py-2.5 rounded-md flex items-center shadow-button">
                            <i class="fa fa-refresh mr-2"></i>测试所有端点
                        </button>
                        <button type="button" onclick="clearAll()" class="btn-hover bg-gray-200 text-gray-700 px-5 py-2.5 rounded-md flex items-center shadow-button hover:bg-gray-300">
                            <i class="fa fa-trash mr-2"></i>清除结果
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm fade-in">
            <p>GitHub自动化字符串更新工具 - API测试界面</p>
            <p class="mt-2"><i class="fa fa-info-circle mr-1"></i>页面加载时会自动测试所有API端点</p>
        </footer>
    </div>

    <script>
        // 带超时和重试机制的API请求测试函数
        async function testEndpoint(endpoint, statusId, resultId, maxRetries = 2) {
            const statusEl = document.getElementById(statusId);
            const resultEl = document.getElementById(resultId);

            // 请求超时设置为10秒
            const fetchWithTimeout = (url, options = {}, timeout = 10000) => {
                return new Promise((resolve, reject) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        reject(new Error('请求超时: ' + timeout + 'ms后未响应'));
                    }, timeout);

                    fetch(url, { ...options, signal: controller.signal })
                        .then(response => {
                            clearTimeout(timeoutId);
                            resolve(response);
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            reject(error);
                        });
                });
            };

            // 实现重试逻辑
            let retries = 0;
            while (retries <= maxRetries) {
                statusEl.innerHTML = retries > 0 ? 
                    '<i class="fa fa-refresh fa-spin mr-1 text-primary"></i>测试中(重试' + retries + '/' + maxRetries + ')...' : 
                    '<i class="fa fa-refresh fa-spin mr-1 text-primary"></i>测试中...';
                statusEl.className = 'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-primary/10 text-primary';
                resultEl.textContent = '';
                resultEl.className = 'whitespace-pre-wrap break-all';

                try {
                    const response = await fetchWithTimeout(endpoint);
                    if (response.ok) {
                        let data;
                        try {
                            data = await response.json();
                        } catch (jsonError) {
                            throw new Error('响应解析错误: ' + jsonError.message);
                        }
                        statusEl.innerHTML = '<i class="fa fa-check-circle mr-1 text-success"></i>成功';
                        statusEl.className = 'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-success-light text-success';
                        resultEl.textContent = JSON.stringify(data, null, 2);
                        resultEl.className = 'whitespace-pre-wrap break-all text-success';
                        return true;
                    } else {
                        const errorText = await response.text();
                        statusEl.innerHTML = retries === maxRetries ? 
                            '<i class="fa fa-times-circle mr-1 text-error"></i>失败' : 
                            '<i class="fa fa-refresh fa-spin mr-1 text-warning"></i>重试中...';
                        statusEl.className = retries === maxRetries ? 
                            'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-error-light text-error' : 
                            'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-yellow-50 text-yellow-700';
                        if (retries === maxRetries) {
                            resultEl.textContent = 'HTTP错误: ' + response.status + ' ' + response.statusText + '\n' + (errorText || '(无详细错误信息)');
                            resultEl.className = 'whitespace-pre-wrap break-all text-error';
                        }
                        if (retries < maxRetries) {
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, 1000 * retries)); // 递增等待时间
                            continue;
                        }
                        return false;
                    }
                } catch (error) {
                    statusEl.innerHTML = retries === maxRetries ? 
                        '<i class="fa fa-times-circle mr-1 text-error"></i>失败' : 
                        '<i class="fa fa-refresh fa-spin mr-1 text-warning"></i>重试中...';
                    statusEl.className = retries === maxRetries ? 
                        'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-error-light text-error' : 
                        'status px-3 py-1 rounded-full text-sm font-medium mr-4 bg-yellow-50 text-yellow-700';
                    if (retries === maxRetries) {
                        resultEl.textContent = '请求错误: ' + error.message;
                        resultEl.className = 'whitespace-pre-wrap break-all text-error';
                    }
                    if (retries < maxRetries && !error.message.includes('超时')) {
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, 1000 * retries));
                        continue;
                    }
                    return false;
                }
            }
        }

        async function testConfig() {
            await testEndpoint('/api/config', 'config-status', 'config-result');
        }

        async function testPages() {
            await testEndpoint('/api/pages', 'pages-status', 'pages-result');
        }

        async function testStats() {
            await testEndpoint('/api/stats', 'stats-status', 'stats-result');
        }

        async function testAll() {
            await testConfig();
            await testPages();
            await testStats();
        }

        function clearAll() {
            document.getElementById('config-status').innerHTML = '<i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试';
            document.getElementById('config-status').className = 'status px-3 py-1 rounded-full text-sm font-medium mr-4';
            document.getElementById('config-result').textContent = '';
            
            document.getElementById('pages-status').innerHTML = '<i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试';
            document.getElementById('pages-status').className = 'status px-3 py-1 rounded-full text-sm font-medium mr-4';
            document.getElementById('pages-result').textContent = '';
            
            document.getElementById('stats-status').innerHTML = '<i class="fa fa-hourglass-half mr-1 text-gray-400"></i>未测试';
            document.getElementById('stats-status').className = 'status px-3 py-1 rounded-full text-sm font-medium mr-4';
            document.getElementById('stats-result').textContent = '';
        }

        // 页面加载时自动测试所有端点
        window.onload = testAll;
    </script>
</body>
</html>

